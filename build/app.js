!function(e){var t={};function o(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,o),n.l=!0,n.exports}o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(r,n,function(t){return e[t]}.bind(null,n));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=8)}([function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("koa-router")},function(e,t,o){const r=o(21),n=o(6),a=o(22),s=o(23);e.exports={Article:class{constructor(){this.model=r}save(e){return new r(e).save()}query(e={},t={},o={}){return this.model.find(e,t,o).populate([{path:"tags"},{path:"category"},{path:"comments"}]).exec()}queryById(e){return this.model.findById(e).populate([{path:"tags"},{path:"category"},{path:"comments"}]).exec()}remove(e,t){return this.model.findById(e).then((function(e){return e?e.remove():t(null,!1)}))}updateComment(e,t){return this.model.findById(e).then(async o=>{if(!o)return fn(null,!1);let r=await new s(t).save(),n=o.comments;return n.push(r._id),this.model.findByIdAndUpdate(e,{comments:n},{new:!0})})}update(e,t){return this.model.findById(e).then(async o=>o?this.model.findByIdAndUpdate(e,t,{new:!0}):fn(null,!1))}},Tag:class{constructor(){this.model=a}save(e){return new a(e).save()}query(e){return this.model.find(e).sort({_id:-1}).exec()}},Category:class{constructor(){this.model=n}query(e){return this.model.find(e).sort({_id:-1}).exec()}}}},function(e,t){e.exports=require("koa-body")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("mongoose-auto-increment")},function(e,t,o){"use strict";var r=o(0);const n=new r.Schema({name:{type:String,required:!0},desc:{type:String,default:""},create_time:{type:Date,default:Date.now},update_time:{type:Date,default:Date.now}});e.exports=r.model("Category",n)},function(e,t){e.exports=require("fs")},function(e,t,o){(function(e){const t=o(9),r=o(10),n=o(11),a=o(1)(),s=o(12),i=o(13),u=o(14),c=o(15),d=o(16),l=(o(3),o(17)),m=new t;n(m);const p=o(18)();p.on("error",console.error.bind(console,"connection error:")),global.dbUser=p.model("users",{email:String,password:String,nick_name:{type:String,default:"长江7号"},avatar:String,status:{type:String,default:"normal"},createTime:{type:Date,default:Date.now},updateTIme:{type:Date,default:Date.now}});const y=o(19),g=o(29),f=o(33);m.use(i()),m.use(d.default()),m.use(s("/favicon.ico",(function(e){e.status=200}))),m.use(r(e+"/src/public/")),m.use(l()),a.use("/loginUser",g.routes(),g.allowedMethods()),a.use("/admin",y.routes(),y.allowedMethods()),a.use("/uploadImg",f.routes(),f.allowedMethods()),m.use(a.routes()),m.use(c()),m.use(u((e,t)=>{console.log(e,"str"),console.log(t,"args")})),m.listen(3e3)}).call(this,"")},function(e,t){e.exports=require("koa")},function(e,t){e.exports=require("koa-static")},function(e,t){e.exports=require("koa-onerror")},function(e,t){e.exports=require("koa-mount")},function(e,t){e.exports=require("koa-bodyparser")},function(e,t){e.exports=require("koa-logger")},function(e,t){e.exports=require("koa2-cors")},function(e,t){e.exports=require("koa-cookie")},function(e,t,o){const r=o(4),n=["/loginUser/info","/admin/addComment"];e.exports=function(){return async function(e,t){if(-1!=n.indexOf(e.path)){console.log(e.path,"登录验证");const o=e.cookies.get("jwtToken-creator")||"";if(!o)return void(e.body={msg:"登录失效",user:{},ok:!1});{let n;try{n=r.verify(o,"jwtToken-creator")}catch(t){return void(e.body={msg:"token无效",user:{},ok:!1})}let a=await global.dbUser.findById({_id:n._id});if(!a)return void(e.body={msg:"登录失效",user:a,ok:!1});await t()}}else await t()}}},function(e,t,o){const r=o(0),n=o(5);e.exports=function(){return r.connect("mongodb://localhost:27017/blog",{keepAlive:120}),n.initialize(r.connection),r.connection}},function(e,t,o){const r=o(1)(),n=o(20),a=o(27),s=o(28);r.get("/article",n.getAll).post("/create",n.createArticle).get("/comment",n.getArticleComment).post("/addComment",n.addArticleComment).get("/getTags",a.getTagsList).post("/addTag",a.addTag).get("/categoryList",s.getCategoryList).post("/updateArticle",n.updateArticle),e.exports=r},function(e,t,o){const{Article:r}=o(2),n=(o(6),new r),{sendMail:a}=o(24);o(7),o(26);e.exports={createArticle:async(e,t)=>{const o=e.request.body;let r=await n.save(o);e.body={ok:!0,message:"创建成功",artList:r}},getAll:async(e,t)=>{const o=e.request.query,r=o&&o.pageNum,a=o&&o.pageSize||20,s=o&&o.articleId,i=o&&o.tag_id,u=o&&o.category_id,c=o&&o.keyword||null,d=o&&o.state,l=(e.request.headers.token,{title:1,author:1,keyword:1,desc:1,img_url:1,tags:1,category:1,comments:1,like_users:1,meta:1,createTime:1,updateTime:1});let m,p={},y={},g=0;if(c){const e=new RegExp(c,"i");p={$and:[{$or:[{state:d}]},{$or:[{title:{$regex:e}},{desc:{$regex:e}}]}]}}r&&(g=r-1<0?0:(r-1)*a),y={skip:g,limit:a-0,sort:{createTime:-1}};let f=0;s?m=await n.queryById({_id:s}):(i&&(p={...p,tags:{_id:i}}),u&&(p={...p,category:{_id:u}}),f=await n.query(p,l,{sort:{createTime:-1}}),m=await n.query(p,l,y)),e.body={data:m,count:f.length}},getArticleComment:async(e,t)=>{const o=e.request.query;let r=await n.queryById(o);e.body=r.comments},addArticleComment:async(e,t)=>{const o=e.request.body,r={_id:o.article_id};if(!o.content)return void(e.body={ok:!1,message:"内容不能空",artList:[]});let a=await n.updateComment(r,o);console.log(a.comments,"res"),e.body={ok:!0,message:"创建成功",artList:a}},updateArticle:async(e,t)=>{const o=e.request.body,r={_id:o.article_id};let a=await n.update(r,o);e.body={ok:!0,message:"更新成功",artList:a}}}},function(e,t,o){"use strict";var r=o(0),n=new r.Schema({title:{type:String,required:!0},keyword:[{type:String,default:""}],author:{type:String,required:!0},desc:{type:String,default:""},content:{type:String,required:!0},img_url:{type:String,default:""},state:{type:Number,default:1},origin:{type:Number,default:0},tags:[{type:r.Schema.Types.ObjectId,ref:"Tag"}],comments:[{type:r.Schema.Types.ObjectId,ref:"Comment"}],category:[{type:r.Schema.Types.ObjectId,ref:"Category"}],like_users:[{id:{type:r.Schema.Types.ObjectId},name:{type:String,required:!0,default:""},avatar:{type:String,default:"user"},create_time:{type:Date,default:Date.now}}],meta:{views:{type:Number,default:0},likes:{type:Number,default:0},comments:{type:Number,default:0}},createTime:{type:Date,default:Date.now},updateTIme:{type:Date,default:Date.now}});e.exports=r.model("Article",n)},function(e,t,o){"use strict";var r=o(0);const n=new r.Schema({name:{type:String,required:!0,validate:/\S+/},desc:String,icon:String,create_time:{type:Date,default:Date.now}});e.exports=r.model("Tag",n)},function(e,t,o){var r=o(0);const n=new r.Schema({article_id:{type:r.Schema.Types.ObjectId,required:!0},content:{type:String,required:!0,validate:/\S+/},is_top:{type:Boolean,default:!1},user_name:{type:String,default:"长江7号"},likes:{type:Number,default:0},avatar:String,state:{type:Number,default:1},create_time:{type:Date,default:Date.now}});e.exports=r.model("Comment",n)},function(e,t,o){let r=o(25).createTransport({service:"qq",host:"smtp.exmail.qq.com",port:465,secure:!0,auth:{user:"382988057@qq.com",pass:"xxxx"}});e.exports={sendMail:function(e,t,o){let n={from:'"Creator-blog" <382988057@qq.com>',to:e,subject:'欢迎来到"Creator-demo"',text:"Hello world?",html:`<p>${t.user_name}给你留言了快去看看吧:</p><a href="http://106.53.236.144/article?articleId=${t.articleId}">点击跳转</a>`};r.sendMail(n,(e,t)=>{o(!e)})}}},function(e,t){e.exports=require("nodemailer")},function(e,t){e.exports=require("path")},function(e,t,o){const{Tag:r}=o(2),n=new r;e.exports={getTagsList:async(e,t)=>{let o=await n.query({});e.body={ok:!0,message:"获取标签成功",tagsList:o}},addTag:async(e,t)=>{const o=e.request.body;let r=await n.query({name:o.name});if(r.length>0)e.body={message:"该标签已存在",data:r,ok:!1};else{let t=await n.save(o);e.body={ok:!0,message:"添加标签成功",tagsList:t}}}}},function(e,t,o){const{Category:r}=o(2),n=new r;e.exports={getCategoryList:async(e,t)=>{let o=await n.query({});e.body={ok:!0,message:"获取分类成功",cateList:o}}}},function(e,t,o){const r=o(1)(),n=o(30);r.post("/login",n.login).post("/register",n.register).get("/info",n.info),e.exports=r},function(e,t,o){const r=o(4),n=new(o(31));e.exports={register:async(e,t)=>{const o=e.request.body;let r=await n.query({email:o.email});if(r.length>0)e.body={message:"该账户已存在",data:r,ok:!1};else{let t=await n.save(o);console.log(t,"tetet"),e.body={msg:"注册成功",data:r,ok:!0}}},login:async(e,t)=>{const o=e.request.body;console.log(o,"opts");let a=await n.query(o);const s=a[0]||"";if(s){const t=r.sign(JSON.stringify(a[0]),"jwtToken-creator");e.body={message:"登陆成功！",user:s,ok:!0,token:t}}else e.body={msg:"用户名或密码错误",user:s,ok:!1}},info:async(e,t)=>{const o=e.cookies.get("jwtToken-creator")||"";if(o){const t=r.verify(o,"jwtToken-creator");let a=await n.queryById({_id:t._id});e.body=a?{message:"获取信息成功",user:a,ok:!0,token:o}:{msg:"登录失效",user:a,ok:!1}}else e.body={msg:"登录失效",user:{},ok:!1}}}},function(e,t,o){const r=o(32);e.exports=class{constructor(){this.model=r}save(e){return new r(e).save(e=>{if(e)return handleError(e)})}query(e={}){return this.model.find(e).exec()}queryById(e){return this.model.findById(e).exec()}}},function(e,t,o){"use strict";const r=o(0),n=o(5);var a=new r.Schema({email:String,password:String,nick_name:{type:String,default:"长江7号"},avatar:String,status:{type:String,default:"normal"},createTime:{type:Date,default:Date.now},updateTIme:{type:Date,default:Date.now}});a.plugin(n.plugin,{model:"User",field:"id",startAt:1,incrementBy:1}),e.exports=r.model("User",a)},function(e,t,o){const r=o(1)(),n=o(34),a=o(3);r.post("/uploadImg",a({multipart:!0,formidable:{maxFileSize:2097152e3}}),n.uploadImg),e.exports=r},function(e,t,o){(function(t){const r=o(7);e.exports={uploadImg:async(e,o)=>{let n=e.request.files;const a=r.createReadStream(n.image.path);console.log(t,"__dirname");let s,i="./src/public/img/"+n.image.name;console.log(process.env,"process.env"),s="http://106.53.236.144:3000/img/"+n.image.name,console.log(i,"filePath");const u=r.createWriteStream(i);return a.pipe(u),e.body={url:s,message:"文件上传成功",ok:!0}}}}).call(this,"src/controllers")}]);